<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claves VPN - VPN Manager</title>
    <style>
        /* Mismos estilos base que dashboard */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        .card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { color: #667eea; }
        .btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85rem;
            margin-right: 5px;
        }
        .btn-danger { background: #e74c3c; }
        .badge { padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; }
        .badge-paid { background: #d4edda; color: #155724; }
        .badge-pending { background: #fff3cd; color: #856404; }
        .progress-bar {
            width: 100px;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            display: inline-block;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîë Gesti√≥n de Claves</h1>
        <div style="margin-top: 15px;">
            <a href="/" style="color: white; text-decoration: none; margin-right: 20px;">‚Üê Dashboard</a>
            <button onclick="syncKeys()" style="padding: 8px 16px; background: rgba(255,255,255,0.2); border: none; color: white; border-radius: 20px; cursor: pointer;">üîÑ Sincronizar con Outline</button>
        </div>
    </div>

    <div class="card">
        <table>
            <thead>
                <tr>
                    <th>Cliente</th>
                    <th>Plan</th>
                    <th>Uso</th>
                    <th>Expira</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for key in keys %}
                <tr>
                    <td>
                        <strong>{{ key.client_name or key.name }}</strong>
                        <br><small>{{ key.name }}</small>
                        {% if key.client_phone %}<br><small>üì± {{ key.client_phone }}</small>{% endif %}
                    </td>
                    <td>{{ key.plan_info.name }}</td>
                    <td>
                        {% if key.plan_info.data_limit_mb %}
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: {{ (key.usage / (key.plan_info.data_limit_mb * 1024 * 1024)) * 100 }}%"></div>
                        </div>
                        <br><small>{{ "%.1f"|format(key.usage / 1024 / 1024) }} / {{ key.plan_info.data_limit_mb }} MB</small>
                        {% else %}
                        <small>ILIMITADO</small>
                        {% endif %}
                    </td>
                    <td>{{ key.expires_at[:10] }}</td>
                    <td><span class="badge badge-{{ key.payment_status }}">{{ key.payment_status }}</span></td>
                    <td>
                        <button class="btn" onclick="share('{{ key.key_id }}', 'whatsapp')">üì±</button>
                        <button class="btn" onclick="share('{{ key.key_id }}', 'telegram')">‚úàÔ∏è</button>
                        <button class="btn btn-danger" onclick="del('{{ key.key_id }}')">üóëÔ∏è</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <script>
        async function syncKeys() {
            const res = await fetch('/api/sync-keys', {method: 'POST'});
            const data = await res.json();
            alert(`Sincronizado! Agregadas: ${data.added}`);
            location.reload();
        }
        
        async function share(keyId, platform) {
            const res = await fetch(`/api/share-key/${keyId}?platform=${platform}`);
            const data = await res.json();
            
            if (data.copy_only) {
                prompt('Copia este mensaje:', data.message);
            } else {
                window.open(data.link, '_blank');
            }
        }
        
        async function del(keyId) {
            if (!confirm('¬øEliminar esta clave?')) return;
            await fetch(`/api/delete-key/${keyId}`, {method: 'DELETE'});
            location.reload();
        }
    </script>
</body>
</html>
